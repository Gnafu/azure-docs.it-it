---
title: Risolvere i problemi relativi al backup di una macchina virtuale di Azure
description: Risolvere i problemi relativi al backup e al ripristino delle macchine virtuali di Azure
services: backup
author: trinadhk
manager: shreeshd
ms.service: backup
ms.topic: conceptual
ms.date: 8/7/2018
ms.author: trinadhk
ms.openlocfilehash: dbd49166bbcb6bbd648b6a64f7eb97d8073f33fc
ms.sourcegitcommit: 275eb46107b16bfb9cf34c36cd1cfb000331fbff
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 11/15/2018
ms.locfileid: "51706824"
---
# <a name="troubleshoot-azure-virtual-machine-backup"></a>Risolvere i problemi relativi al backup delle macchine virtuali di Azure
È possibile risolvere gli errori rilevati durante l'uso di Backup di Azure con le informazioni elencate nella tabella seguente.

| Dettagli errore | Soluzione alternativa |
| --- | --- |
| Impossibile eseguire l'operazione perché la VM non esiste più. Arrestare la protezione della macchina virtuale senza eliminare i dati del backup. Per altre informazioni: http://go.microsoft.com/fwlink/?LinkId=808124. |Questo si verifica quando la macchina virtuale primaria viene eliminata, ma i criteri di backup continuano a cercare una macchina virtuale per il backup. Per correggere l'errore:  <ol><li> Ricreare la macchina virtuale con lo stesso nome e lo stesso nome del gruppo di risorse [nome del servizio cloud],<br>OPPURE</li><li> Interrompere la protezione della macchina virtuale cancellando o senza eliminare i dati del backup. [Altre informazioni](https://go.microsoft.com/fwlink/?LinkId=808124)</li></ol> |
| Operazione di creazione snapshot non riuscita a causa dell'assenza della connettività di rete nella macchina virtuale. Assicurarsi che la VM abbia accesso alla rete. Per la corretta creazione dello snapshot, aggiungere all'elenco elementi consentiti gli intervalli IP del data center di Azure oppure configurare un server proxy per l'accesso di rete. Per altre informazioni, vedere http://go.microsoft.com/fwlink/?LinkId=800034. Se si usa già il server proxy, assicurarsi che le impostazioni del server proxy siano configurate correttamente. | Questa situazione si verifica quando si nega la connettività Internet in uscita nella macchina virtuale. L'estensione snapshot della macchina virtuale richiede connettività Internet per creare uno snapshot dei dischi sottostanti. [Vedere la sezione su come risolvere gli errori degli snapshot dovuti all'accesso di rete bloccato](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#ExtensionSnapshotFailedNoNetwork-snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine). |
| L'agente di macchine virtuali non riesce a comunicare con il servizio Backup di Azure. Verificare la connettività di rete della macchina virtuale e che l'agente di macchine virtuali sia in esecuzione con la versione più recente. Per altre informazioni, vedere l'articolo http://go.microsoft.com/fwlink/?LinkId=800034. |Questo errore viene generato se si verifica un problema con l'agente di VM o se l'accesso di rete all'infrastruttura di Azure è bloccato in qualche modo. Vedere [altre informazioni](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#UserErrorGuestAgentStatusUnavailable-vm-agent-unable-to-communicate-with-azure-backup) sul debug dei problemi di snapshot della VM.<br> Se l'agente di macchine virtuali non causa problemi, riavviare la macchina virtuale. Uno stato della macchina virtuale non corretto può causare problemi; per reimpostarlo, riavviare la macchina virtuale. |
| Lo stato di provisioning della macchina virtuale è Non riuscito. Riavviare la macchina virtuale e assicurarsi che sia in esecuzione o arrestata. | Questo errore si verifica quando lo stato del provisioning della macchina virtuale è Non riuscito a seguito degli errori di una delle estensioni. Passare all'elenco di estensioni e verificare se è presente un'estensione con errore, rimuoverla e provare a riavviare la macchina virtuale. Se tutte le estensioni sono in stato di esecuzione, verificare se è in esecuzione il servizio agente di macchine virtuali. In caso contrario, riavviare il servizio agente di macchine virtuali. |
| L'operazione dell'estensione VMSnapshot non è riuscita per i dischi gestiti. Ripetere l'operazione di backup. Se il problema persiste, seguire le istruzioni in 'http://go.microsoft.com/fwlink/?LinkId=800034'. Se il problema non viene risolto, contattare il supporto tecnico Microsoft | Questo errore si verifica quando il servizio Backup non riesce ad attivare uno snapshot. [Altre informazioni](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#ExtentionOperationFailed-vmsnapshot-extension-operation-failed) sul debug dei problemi delle VM relativi agli snapshot. |
| Non è stato possibile copiare lo snapshot della macchina virtuale a causa dello spazio disponibile insufficiente nell'account di archiviazione. Assicurarsi che lo spazio disponibile nell'account di archiviazione sia equivalente ai dati presenti nei dischi di archiviazione Premium collegati alla macchina virtuale. | Nel caso di macchine virtuali Premium nello stack V1 di backup di macchine virtuali, lo snapshot deve essere copiato nell'account di archiviazione, in modo da assicurare che il traffico di gestione dei backup, che funziona sullo snapshot, non limiti il numero di IOPS disponibili all'applicazione che usa i dischi Premium. Microsoft consiglia di allocare solo il 50% (17,5 TB) dello spazio totale dell'account di archiviazione, in modo che il servizio Backup di Azure possa copiare lo snapshot nell'account di archiviazione e trasferire i dati da questa posizione, copiata nell'account, di archiviazione all'insieme di credenziali. |
| Non è possibile eseguire l'operazione perché l'agente di macchine virtuali non risponde |Questo errore viene generato se si verifica un problema con l'agente di VM o se l'accesso di rete all'infrastruttura di Azure è bloccato in qualche modo. Per le macchine virtuali di Windows, controllare lo stato del servizio agente di macchine virtuali nella sezione dei servizi e verificare che l'agente venga visualizzato tra i programmi nel pannello di controllo. Provare a rimuovere il programma dal pannello di controllo e a reinstallare l'agente come indicato di [seguito](#vm-agent). Dopo aver reinstallato l'agente, attivare un backup ad-hoc per verificare. |
| Operazione di estensione dei servizi di ripristino non riuscita. - Assicurarsi che nella macchina virtuale sia presente l'agente di macchine virtuali più recente e che il servizio agente sia in esecuzione. Ripetere l'operazione di backup. In caso di esito negativo, contattare il supporto tecnico Microsoft. |Questo errore viene generato quando l'agente VM non è aggiornato. Per aggiornare l'agente VM, fare riferimento alla sezione "Aggiornamento dell'agente VM" riportata di seguito. |
| La macchina virtuale non esiste. - Verificare che la macchina virtuale sia presente o selezionarne un'altra. |Questo problema si verifica quando viene rilevata la macchina virtuale primaria ma i criteri di backup continuano a cercare una macchina virtuale per il backup. Per correggere l'errore:  <ol><li> Ricreare la macchina virtuale con lo stesso nome e lo stesso nome del gruppo di risorse [nome del servizio cloud],<br>OPPURE<br></li><li>Interrompere la protezione della macchina virtuale senza eliminare i dati del backup. [Altre informazioni](https://go.microsoft.com/fwlink/?LinkId=808124)</li></ol> |
| L'esecuzione del comando non è riuscita. In questo elemento è attualmente in corso un'altra operazione. Attendere il completamento dell'operazione precedente, quindi riprovare. |È in esecuzione un processo di backup esistente e non è possibile avviare un nuovo processo fino al termine di quello corrente. |
| Si è verificato il timeout della copia dei dischi rigidi virtuali dall'insieme di credenziali di Servizi di ripristino - Attendere qualche minuto prima di ripetere l'operazione. Se il problema persiste, contattare il supporto tecnico Microsoft. | Questa situazione si verifica in presenza di un errore temporaneo sul lato dell'archiviazione o se il servizio Backup non riceve operazioni di I/O al secondo dell'account di archiviazione sufficienti a trasferire i dati nell'insieme di credenziali entro il periodo di timeout. Assicurarsi di seguire le [procedure consigliate quando si configurano le macchine virtuali](backup-azure-vms-introduction.md#best-practices). Spostare la macchina virtuale in un account di archiviazione diverso non caricato e ripetere il processo di backup.|
| Il backup non è riuscito e si è verificato un errore interno - Attendere qualche minuto prima di ripetere l'operazione. Se il problema persiste, contattare il supporto tecnico Microsoft. |È possibile ricevere questo errore per due motivi: <ol><li> È stato riscontrato un problema temporaneo nell'accesso all'archiviazione della macchina virtuale. Consultare il [sito Stato di Azure](https://azure.microsoft.com/status/) per vedere se nell'area geografica ci sono problemi di calcolo, archiviazione o rete. Dopo aver risolto il problema, ripetere il processo di backup. <li>La macchina virtuale originale è stata eliminata e non è possibile ricorrere al punto di ripristino. Per mantenere i dati di backup per una macchina virtuale eliminata, rimuovendo gli errori di backup: interrompere la protezione della macchina virtuale e selezionare l'opzione di conservazione dei dati. Questa operazione interrompe il processo di backup pianificato e i messaggi di errore ricorrenti. |
| Non è stato possibile installare l'estensione Servizi di ripristino di Azure nell'elemento selezionato. L'agente VM è un prerequisito dell'estensione Servizi di ripristino di Azure. Installare l'agente VM di Azure e riavviare l'operazione di registrazione |<ol> <li>Controllare se l'agente di VM è stato installato correttamente. <li>Assicurarsi che il flag sul file di configurazione della macchina virtuale sia impostato correttamente.</ol> [Altre informazioni](#validating-vm-agent-installation) sull'installazione dell'agente VM e su come convalidarla. |
| L'installazione dell'estensione non è riuscita con un errore che indica che il servizio COM+ non può comunicare con Microsoft Distributed Transaction Coordinator |Questo errore in genere indica che il servizio COM+ non è in esecuzione. Per informazioni su come correggere l'errore, contattare il supporto tecnico Microsoft. |
| L'operazione di snapshot non è riuscita con un errore dell'operazione del Servizio Copia Shadow del volume che indica che l'unità è bloccata da Crittografia unità BitLocker. È necessario sbloccare l'unità dal Pannello di controllo. |Disattivare BitLocker per tutte le unità della macchina virtuale e verificare se il problema relativo al Servizio Copia Shadow del volume è stato risolto |
| Lo stato della macchina virtuale non consente i backup. |<ul><li>Se la macchina virtuale si trova in uno stato temporaneo tra **In esecuzione** e **Arresto**, attendere che lo stato cambi, quindi attivare il processo di backup. <li> Se la macchina virtuale è Linux e usa il modulo del kernel Security Enhanced Linux, escludere il percorso dell'agente Linux (_/var/lib/waagent_) dai criteri di sicurezza e assicurarsi che l'estensione di backup sia installata.  |
| La macchina virtuale di Azure non è stata trovata. |Questo errore si verifica quando la macchina virtuale primaria viene eliminata, ma i criteri di backup continuano a cercarla. Per correggere l'errore:  <ol><li>Ricreare la macchina virtuale con lo stesso nome e lo stesso nome del gruppo di risorse [nome del servizio cloud], <br>OPPURE <li> Disabilitare la protezione per questa macchina virtuale affinché i processi di backup non vengano creati. </ol> |
| L'agente di macchine virtuali non è presente nella macchina virtuale. Installare i prerequisiti necessari e l'agente di macchine virtuali, quindi ripetere l'operazione. |[Altre informazioni](#vm-agent) sull'installazione dell'agente di VM e su come convalidare l'installazione dell'agente di VM. |
| L'operazione di snapshot non è riuscita a causa dello stato non corretto dei VSS writer |È necessario riavviare i VSS (servizio Copia Shadow del volume) writer con stato non corretto. A questo scopo, da un prompt dei comandi con privilegi elevati eseguire ```vssadmin list writers```. L'output contiene tutti i VSS writer con lo stato. Riavviare ogni VSS writer con stato diverso da "[1] Stable" usando i comandi seguenti da un prompt dei comandi con privilegi elevati:<br> ```net stop serviceName``` <br> ```net start serviceName```|
| L'operazione di snapshot non è riuscita a causa di un errore di analisi della configurazione |Questo problema si verifica a causa della modifica delle autorizzazioni nella directory MachineKeys: _%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys_ <br> Eseguire il comando seguente e verificare che le autorizzazioni per la directory MachineKeys siano quelle predefinite:<br>_icacls %systemdrive%\programdata\microsoft\crypto\rsa\machinekeys_ <br><br> Le autorizzazioni predefinite sono:<br>Everyone:(R,W) <br>BUILTIN\Administrators:(F)<br><br>Se vengono visualizzate autorizzazioni per la directory MachineKeys diverse da quelle predefinite, seguire la procedura riportata di seguito per correggere le autorizzazioni, eliminare il certificato e attivare il backup.<ol><li>Correggere le autorizzazioni per la directory MachineKeys.<br>Usando le impostazioni di protezione avanzate e le proprietà di sicurezza di Explorer nella directory, ripristinare le autorizzazioni ai valori predefiniti. Rimuovere tutti gli oggetti utente (tranne quelli predefiniti) dalla directory e assicurarsi che l'autorizzazione **Tutti** abbia accesso speciale per:<br>-Elencare cartelle/leggere dati <br>-Leggere attributi <br>-Leggere attributi estesi <br>-Creare file/scrivere dati <br>-Creare cartelle/aggiungere dati<br>-Scrivere attributi<br>-Scrivere attributi estesi<br>-Leggere autorizzazioni<br><br><li>Eliminare tutti i certificati in cui **Rilasciato a** o **Windows Azure CRP Certificate Generator** è il modello di distribuzione classica.<ul><li>[Aprire la console Certificati (computer locale)](https://msdn.microsoft.com/library/ms788967(v=vs.110).aspx)<li>In **Personale** > **Certificati** eliminare tutti i certificati in cui **Rilasciato a** o **Windows Azure CRP Certificate Generator** è il modello di distribuzione classica.</ul><li>Attivare un processo di backup della macchina virtuale. </ol>|
| Il servizio backup di Azure non possiede autorizzazioni sufficienti nel Key Vault per il backup di macchine virtuali crittografate. |Il servizio di backup deve ricevere queste autorizzazioni in PowerShell tramite la procedura indicata nella sezione **Abilitazione del backup** della [Documentazione di PowerShell](backup-azure-vms-automation.md). |
|L'installazione dell'estensione dello snapshot non è riuscita con un errore che indica che il servizio COM+ non può comunicare con Microsoft Distributed Transaction Coordinator | Da un prompt dei comandi con privilegi elevati avviare il servizio Windows "Applicazione sistema COM+", ad esempio _net start COMSysApp_. <br>Se il servizio non viene avviato:<ol><li> Assicurarsi che l'account di accesso del servizio "Distributed Transaction Coordinator" sia "Servizio di rete". In caso contrario, modificarlo in "Servizio di rete", riavviare il servizio e quindi provare ad avviare "Applicazione di sistema COM+".<li>Se il servizio "Applicazione di sistema COM+" non viene avviato, usare la procedura seguente per disinstallare/installare il servizio"Distributed Transaction Coordinator":<br> - Arrestare il servizio MSDTC<br> - Aprire un prompt dei comandi (cmd) <br> - Eseguire il comando ```msdtc -uninstall``` <br> - Eseguire il comando ```msdtc -install``` <br> - Avviare il servizio MSDTC<li>Avviare il servizio Windows "Applicazione di sistema COM+". Dopo che il servizio "Applicazione sistema COM+" è stato avviato, attivare un processo di backup dal portale di Azure.</ol> |
|  L'operazione di creazione snapshot non è riuscita a causa di un errore COM+ | L'azione consigliata è di riavviare il servizio di Windows "Applicazione di sistema COM+" (da un prompt dei comandi con privilegi elevati - _net start COMSysApp_). Se il problema persiste, riavviare la macchina virtuale. Se anche il riavvio della macchina virtuale non consente di risolvere il problema, provare a [rimuovere l'estensione VMSnapshot](https://docs.microsoft.com/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#cause-3-the-backup-extension-fails-to-update-or-load) e ad attivare il backup manualmente. |
| Impossibile bloccare uno o più punti di montaggio della macchina virtuale per creare uno snapshot coerente con il file system | Seguire questa procedura: <ol><li>Controllare lo stato del file system di tutti i dispositivi montati tramite il comando _'tune2fs'_.<br> Ad esempio: tune2fs -l /dev/sdb1 \| grep "Filesystem state" <li>Smontare i dispositivi il cui stato del file system non è pulito tramite il comando _'umount'_. <li> Eseguire il controllo FileSystemConsistency su tali dispositivi tramite il comando _'fsck'_. <li> Montare di nuovo i dispositivi e provare a eseguire il backup.</ol> |
| L'operazione di snapshot non è riuscita a causa di un errore durante la creazione del canale di comunicazione di rete protetta | <ol><Li> Aprire l'editor del Registro di sistema eseguendo regedit.exe con privilegi elevati. <li> Identificare tutte le versioni di .NET Framework presenti nel sistema. disponibili nella gerarchia della chiave del Registro di sistema "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft" <li> Per ogni versione di .NET Framework presente nella chiave del Registro di sistema, aggiungere la chiave seguente: <br> "SchUseStrongCrypto"=dword:00000001 </ol>|
| L'operazione di snapshot non è riuscita a causa di un errore durante l'installazione di Visual C++ Redistributable per Visual Studio 2012 | Andare a C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\agentVersion e installare vcredist2012_x64. Assicurarsi che il valore della chiave del Registro di sistema per consentire l'installazione del servizio sia impostato correttamente: il valore della chiave del Registro di sistema _HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver_ deve essere impostato su 3, non su 4. Se i problemi di installazione persistono, riavviare il servizio di installazione eseguendo _MSIEXEC /UNREGISTER_ e quindi _MSIEXEC /REGISTER_ da un prompt dei comandi con privilegi elevati.  |


## <a name="jobs"></a>Processi
| Dettagli errore | Soluzione alternativa |
| --- | --- |
| L'annullamento non è supportato per questo tipo di processo. Attendere il completamento del processo. |Nessuna |
| Il processo non si trova in uno stato annullabile. Attendere il completamento del processo. <br>Oppure<br> Il processo selezionato non si trova in uno stato annullabile. Attendere il completamento del processo. |Con tutta probabilità, il processo è quasi completo. Attendere che il processo venga completato.|
| Non è possibile annullare il processo perché non è in corso. L'annullamento è supportato solo per i processi in corso. Tentativo di annullamento di un processo in corso. |Questo errore è causato da uno stato temporaneo. Attendere un minuto e ripetere l'operazione di annullamento. |
| Non è stato possibile annullare il processo. Attendere il completamento del processo. |Nessuna |

## <a name="restore"></a>Restore
| Dettagli errore | Soluzione alternativa |
| --- | --- |
| Ripristino non riuscito con errore interno del cloud |<ol><li>Il servizio cloud in cui si sta tentando di eseguire il ripristino è configurato con le impostazioni DNS. Verificare  <br>$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings<br>Se è presente un indirizzo configurato, significa che le impostazioni DNS sono configurate.<br> <li>Il servizio cloud che si sta tentando di ripristinare è configurato con ReservedIP e le macchine virtuali esistenti nel servizio cloud sono in stato di arresto.<br>È possibile controllare che il servizio cloud disponga di un IP riservato tramite i cmdlet di PowerShell seguenti:<br>$deployment = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName <br><li>Si sta tentando di ripristinare una macchina virtuale con le configurazioni di rete speciali seguenti nello stesso servizio cloud. <br>- Macchine virtuali con configurazione del servizio di bilanciamento del carico (interno ed esterno)<br>- Macchine virtuali con più indirizzi IP riservati<br>- Macchine virtuali con più schede di rete<br> Selezionare un nuovo servizio cloud nell'interfaccia utente o vedere le [considerazioni sul ripristino](backup-azure-arm-restore-vms.md#restore-vms-with-special-network-configurations) per le macchine virtuali con configurazioni di rete speciali.</ol> |
| Il nome DNS selezionato è già in uso. Specificare un nome DNS diverso e riprovare. |Il nome DNS fa riferimento al nome del servizio cloud, che in genere termina con .cloudapp.net. Questo nome deve essere univoco. Se si verifica questo errore, è necessario scegliere un altro nome di macchina virtuale durante il ripristino. <br><br>  Questo errore viene visualizzato solo dagli utenti del portale di Azure. L'operazione di ripristino tramite PowerShell riuscirà perché ripristina solo i dischi e non crea la macchina virtuale. L'errore viene restituito quando la macchina virtuale viene creata in modo esplicito dall'utente dopo l'operazione di ripristino dei dischi. |
| La configurazione di rete virtuale specificata non è corretta. Specificare un'altra configurazione di rete virtuale e riprovare. |Nessuna |
| Il servizio cloud specificato usa un indirizzo IP riservato che non corrisponde alla configurazione della macchina virtuale in fase di ripristino. Specificare un altro servizio cloud che non usa un indirizzo IP riservato o scegliere un altro punto di ripristino da cui eseguire l'operazione. |Nessuna |
| Il servizio cloud ha raggiunto il limite consentito per il numero di endpoint di input. Ripetere l'operazione specificando un altro servizio cloud o usando un endpoint esistente. |Nessuna |
| L'insieme di credenziali di Servizi di ripristino e l'account di archiviazione di destinazione si trovano in due aree diverse - Assicurarsi che l'account di archiviazione specificato nell'operazione di ripristino si trovi nella stessa area di Azure dell'insieme di credenziali di Servizi di ripristino. |Nessuna |
| L'account di archiviazione specificato per l'operazione di ripristino non è supportato. Sono supportati solo gli account di archiviazione dei piani Basic/Standard con le impostazioni di replica con ridondanza locale o ridondanza geografica. Selezionare un account di archiviazione supportato |Nessuna |
| Il tipo di account di archiviazione specificato per l'operazione di ripristino non è online. Assicurarsi che l'account di archiviazione specificato nell'operazione di ripristino sia online |Questo problema può essere provocato da un errore temporaneo nel servizio di archiviazione di Azure o da un'interruzione del servizio. Scegliere un altro account di archiviazione. |
| È stata raggiunta la quota del gruppo di risorse. Eliminare alcuni gruppi di risorse dal portale di Azure o contattare il supporto tecnico di Azure per richiedere un aumento dei limiti. |Nessuna |
| La subnet selezionata non esiste. Selezionare una subnet esistente |Nessuna |
| Il servizio Backup non ha l'autorizzazione per accedere alle risorse nella sottoscrizione. |Per risolvere questo problema, ripristinare prima di tutto i dischi seguendo la procedura illustrata nella sezione **Ripristino dei dischi sottoposti a backup** in [Scelta di una configurazione di ripristino per la macchina virtuale](backup-azure-arm-restore-vms.md#choose-a-vm-restore-configuration). Seguire quindi la procedura di PowerShell illustrata in [Creare una macchina virtuale da dischi ripristinati](backup-azure-vms-automation.md#create-a-vm-from-restored-disks) per creare una macchina virtuale completa dai dischi ripristinati. |

## <a name="backup-or-restore-taking-time"></a>Il backup o il ripristino richiede del tempo
In caso di eccessivo allungamento del tempo di backup (> 12 ore) o di ripristino (> 6 ore):
* Comprendere i [fattori che incidono sul tempo di backup](backup-azure-vms-introduction.md#total-vm-backup-time) e i [fattori che incidono sul tempo di ripristino](backup-azure-vms-introduction.md#total-restore-time).
* Assicurarsi di seguire le [Procedure consigliate per il backup](backup-azure-vms-introduction.md#best-practices).

## <a name="vm-agent"></a>Agente di macchine virtuali
### <a name="setting-up-the-vm-agent"></a>Configurazione dell'agente di VM
L'agente di VM è in genere già presente nelle VM create dalla raccolta di Azure. Nelle macchine virtuali di cui viene eseguita la migrazione da data center locali non è installato l'agente di VM. Per queste VM è necessario installare esplicitamente l'agente di VM.

Per VM di Windows:

* Scaricare e installare il file [MSI per l'agente](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Per completare l'installazione sono necessari privilegi di amministratore.
* Per le macchine virtuali classiche, [aggiornare le proprietà della macchina virtuale](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) per indicare che l'agente è stato installato. Questo passaggio non è necessario per le macchine virtuali di Resource Manager.

Per le macchine virtuali Linux:

* Installare la versione più recente dell'agente dal repository di distribuzione. Per informazioni dettagliate sul nome del pacchetto, vedere il [repository dell'agente Linux](https://github.com/Azure/WALinuxAgent).
* Per le macchine virtuali classiche, [usare la voce del blog per aggiornare le proprietà della macchina virtuale](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) e verificare che l'agente sia installato. Questo passaggio non è necessario per le macchine virtuali di Resource Manager.

### <a name="updating-the-vm-agent"></a>Aggiornamento dell'agente di VM
Per VM di Windows:

* Per aggiornare l'agente di macchine virtuali, reinstallare i [file binari dell'agente di macchine virtuali](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Prima di aggiornare l'agente, assicurarsi che non venga eseguita alcuna operazione di backup durante l'aggiornamento dell'agente di macchine virtuali.

Per le macchine virtuali Linux:

* Per aggiornare l'agente di macchine virtuali Linux, seguire le istruzioni nell'articolo [Aggiornamento dell'agente di macchine virtuali Linux](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
**È consigliabile usare sempre il repository di distribuzione per aggiornare l'agente**. Non scaricare il codice dell'agente da GitHub. Se l'agente più recente non è disponibile per la distribuzione, contattare il supporto per la distribuzione per istruzioni su come trovare l'agente più recente. È anche possibile trovare le informazioni più recenti sull'[agente Linux di Microsoft Azure](https://github.com/Azure/WALinuxAgent/releases) nel repository GitHub.

### <a name="validating-vm-agent-installation"></a>Convalida dell'installazione dell'agente di VM

Per verificare la versione dell'agente di macchine virtuali nelle macchine virtuali di Windows:

1. Accedere alla macchina virtuale di Azure e passare alla cartella *C:\WindowsAzure\Packages*. che dovrebbe includere il file WaAppAgent.exe.
2. Fare clic con il pulsante destro del mouse sul file, scegliere **Proprietà** e quindi selezionare la scheda **Dettagli**. Il campo Versione prodotto deve essere 2.6.1198.718 o superiore.

## <a name="troubleshoot-vm-snapshot-issues"></a>Risoluzione dei problemi relativi allo snapshot della macchina virtuale
Il backup delle macchine virtuali si basa sull'esecuzione dei comandi di snapshot sull'archiviazione sottostante. Non disporre dell'accesso all'archiviazione o il ritardo nell'esecuzione dell'attività dello snapshot può causare il fallimento del processo di backup. I seguenti elementi possono causare il fallimento dell'attività di backup.

1. L'accesso alla rete per l'archiviazione è bloccato mediante NSG<br>
    Vedere altre informazioni su come [abilitare l'accesso alla rete](backup-azure-arm-vms-prepare.md#establish-network-connectivity) per l'archiviazione tramite gli elenchi di indirizzi IP consentiti o un server proxy.
2. Le macchine virtuali con il backup di SQL Server configurato possono causare ritardi nelle attività di snapshot <br>
   Per impostazione predefinita, il backup delle macchine virtuali genera un backup completo Servizio Copia Shadow del volume nelle macchine virtuali Windows. Le macchine virtuali che eseguono SQL Server, con il backup di SQL Server configurato, possono sperimentare ritardi degli snapshot. Se i ritardi degli snapshot causano errori di backup, impostare la seguente chiave del Registro di sistema.

   ```
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```

3. Stato della VM segnalato in modo non corretto perché la VM viene arrestata in RDP.  <br>
   Se è stato usato il desktop remoto per arrestare la macchina virtuale, verificare che lo stato della macchina virtuale nel portale sia corretto. Se lo stato non è corretto, usare l'opzione **Arresto** nel dashboard della macchina virtuale del portale per arrestare la macchina virtuale.
4. Se più di quattro macchine virtuali condividono il servizio cloud, distribuirle tra più criteri di backup. Distribuire gli orari del backup in modo che non più di quattro backup delle macchine virtuali vengano avviati nello stesso momento. Provare a separare di almeno un'ora gli orari di inizio dei criteri.
5. La VM è in esecuzione con un uso elevato di CPU/memoria.<br>
   Se la macchina virtuale è in esecuzione con un uso elevato della memoria o della CPU (> 90%), l'attività di snapshot viene messa in coda, ritardata e infine messa in timeout. In questo caso, provare a eseguire un backup su richiesta.

<br>

## <a name="networking"></a>Rete
Analogamente a tutte le estensioni, per il funzionamento delle estensioni di Backup è necessario l'accesso a Internet pubblico. L'assenza di accesso a Internet pubblico può manifestarsi in diversi modi:

* Possono verificarsi errori di installazione dell'estensione.
* Possono verificarsi errori delle operazioni di backup, ad esempio lo snapshot del disco.
* Possono verificarsi errori di visualizzazione dello stato dell'operazione di backup.

La necessità di risolvere gli indirizzi Internet pubblici è stata illustrata [qui](https://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). È necessario controllare le configurazioni DNS per la rete virtuale e assicurarsi che sia possibile risolvere gli URI di Azure.

Dopo la corretta risoluzione dei nomi, sarà necessario fornire anche l'accesso agli IP di Azure. Per sbloccare l'accesso all'infrastruttura di Azure, eseguire la procedura seguente:

1. Aggiungere gli intervalli IP dei data center di Azure all'elenco elementi consentiti.
   * Ottenere l'elenco di [IP dei data center di Azure](https://www.microsoft.com/download/details.aspx?id=41653) da aggiungere all'elenco di IP consentiti.
   * Sbloccare gli IP mediante il cmdlet [New-NetRoute](https://docs.microsoft.com/powershell/module/nettcpip/new-netroute) . Eseguire questo cmdlet all’interno della macchina virtuale di Azure, in una finestra di PowerShell con privilegi elevati, eseguita come amministratore.
   * Aggiungere regole al gruppo di sicurezza di rete (se esistente) per consentire l'accesso agli indirizzi IP.
2. Creare un percorso per il flusso del traffico HTTP
   * Se si dispone di alcune limitazioni di rete (un gruppo di sicurezza di rete, ad esempio) distribuire un server proxy HTTP per indirizzare il traffico. I passaggi per distribuire un server proxy HTTP sono reperibili [qui](backup-azure-arm-vms-prepare.md#establish-network-connectivity).
   * Aggiungere regole al gruppo di sicurezza di rete (se esistente) per consentire l'accesso a INTERNET dal proxy HTTP.

> [!NOTE]
> DHCP deve essere abilitato nel computer guest per consentire il funzionamento del backup delle VM IaaS. Se è necessario un indirizzo IP privato statico, configurarlo tramite il **portale di Azure** oppure **PowerShell** e assicurarsi che l'opzione DHCP all'interno della macchina virtuale sia abilitata.
> Per altre informazioni su come configurare un indirizzo IP statico tramite PowerShell, vedere le istruzioni per una [macchina virtuale classica](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm) e per una [macchina virtuale di Resource Manager](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface).
>
>
